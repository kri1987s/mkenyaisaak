{% extends 'base.html' %}

{% block title %}Verify Tickets - Mkenya Isaak 7 Million{% endblock %}

{% block content %}
<div class="container py-5">
    <div class="row justify-content-center">
        <div class="col-lg-8">
            <div class="card shadow-sm border-0">
                <div class="card-header bg-primary text-white py-4 text-center">
                    <h2 class="h4 mb-0">Ticket Verification</h2>
                    <p class="mb-0">Check your ticket status using your phone number or M-Pesa receipt</p>
                </div>
                <div class="card-body p-4">
                    <form id="verify-ticket-form">
                        {% csrf_token %}
                        
                        <div class="mb-4">
                            <label for="verification_method" class="form-label fw-bold">How do you want to verify?</label>
                            <select class="form-select" id="verification_method" required>
                                <option value="">Select verification method</option>
                                <option value="phone">By Phone Number (recommended)</option>
                                <option value="receipt">By M-Pesa Receipt Number</option>
                                <option value="booking">By Booking ID</option>
                            </select>
                        </div>
                        
                        <div class="mb-4" id="phone-input" style="display: none;">
                            <label for="phone_number" class="form-label">Phone Number</label>
                            <input type="tel" class="form-control" id="phone_number" placeholder="Enter phone number (e.g., 0712345678)">
                            <div class="form-text">Enter the phone number you used to make the payment</div>
                        </div>
                        
                        <div class="mb-4" id="receipt-input" style="display: none;">
                            <label for="receipt_number" class="form-label">M-Pesa Receipt Number</label>
                            <input type="text" class="form-control" id="receipt_number" placeholder="Enter M-Pesa receipt number (e.g., QFG34KJ8U1)">
                            <div class="form-text">This is the code you received in your M-Pesa SMS confirmation</div>
                        </div>
                        
                        <div class="mb-4" id="booking-input" style="display: none;">
                            <label for="booking_id" class="form-label">Booking ID</label>
                            <input type="text" class="form-control" id="booking_id" placeholder="Enter booking ID">
                            <div class="form-text">This is the booking reference you received after payment</div>
                        </div>
                        
                        <div class="d-grid gap-2">
                            <button type="submit" class="btn btn-primary btn-lg" id="verify-btn">
                                <span id="verify-btn-text">Verify Tickets</span>
                                <span id="verify-btn-spinner" class="spinner-border spinner-border-sm d-none" role="status"></span>
                            </button>
                            <a href="{% url 'events:event_list' %}" class="btn btn-outline-secondary">Back to Events</a>
                        </div>
                    </form>
                    
                    <div id="result-container" class="mt-4" style="display: none;">
                        <div class="alert alert-success">
                            <h5 class="alert-heading">Verification Successful!</h5>
                            <p id="result-message"></p>
                        </div>
                        
                        <div id="booking-details" class="mt-3">
                            <!-- Booking details will be populated here -->
                        </div>
                    </div>
                    
                    <div id="error-container" class="mt-4" style="display: none;">
                        <div class="alert alert-danger">
                            <h5 class="alert-heading">Verification Failed!</h5>
                            <p id="error-message"></p>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
document.addEventListener('DOMContentLoaded', function() {
    const verifyForm = document.getElementById('verify-ticket-form');
    const verifyBtn = document.getElementById('verify-btn');
    const verifyBtnText = document.getElementById('verify-btn-text');
    const verifyBtnSpinner = document.getElementById('verify-btn-spinner');
    const verifyMethodSelect = document.getElementById('verification_method');
    const phoneInput = document.getElementById('phone-input');
    const receiptInput = document.getElementById('receipt-input');
    const bookingInput = document.getElementById('booking-input');
    const resultContainer = document.getElementById('result-container');
    const errorContainer = document.getElementById('error-container');
    const resultMessage = document.getElementById('result-message');
    const errorMessage = document.getElementById('error-message');

    // Show/hide input fields based on verification method
    verifyMethodSelect.addEventListener('change', function() {
        phoneInput.style.display = 'none';
        receiptInput.style.display = 'none';
        bookingInput.style.display = 'none';
        
        const method = this.value;
        if (method === 'phone') {
            phoneInput.style.display = 'block';
        } else if (method === 'receipt') {
            receiptInput.style.display = 'block';
        } else if (method === 'booking') {
            bookingInput.style.display = 'block';
        }
    });

    // Handle form submission
    verifyForm.addEventListener('submit', function(e) {
        e.preventDefault();
        
        const method = verifyMethodSelect.value;
        let verificationValue = '';
        
        if (!method) {
            showErrorMessage('Please select a verification method');
            return;
        }
        
        if (method === 'phone') {
            verificationValue = document.getElementById('phone_number').value;
            if (!verificationValue) {
                showErrorMessage('Please enter your phone number');
                return;
            }
        } else if (method === 'receipt') {
            verificationValue = document.getElementById('receipt_number').value;
            if (!verificationValue) {
                showErrorMessage('Please enter your M-Pesa receipt number');
                return;
            }
        } else if (method === 'booking') {
            verificationValue = document.getElementById('booking_id').value;
            if (!verificationValue) {
                showErrorMessage('Please enter your booking ID');
                return;
            }
        }
        
        performVerification(method, verificationValue);
    });
    
    function performVerification(method, value) {
        // Show loading state
        verifyBtn.disabled = true;
        verifyBtnSpinner.classList.remove('d-none');
        verifyBtnText.textContent = 'Verifying...';
        
        // Hide previous results
        resultContainer.style.display = 'none';
        errorContainer.style.display = 'none';
        
        let url = '';
        let params = new URLSearchParams();
        
        if (method === 'phone') {
            url = '{% url "events:check_payment_status_by_phone" %}';
            params.append('phone', value);
        } else if (method === 'receipt') {
            url = '{% url "events:check_payment_status_by_receipt" %}';
            params.append('receipt', value);
        } else if (method === 'booking') {
            url = '/events/api/payment-status/' + value + '/';
        }
        
        if (method !== 'booking') {
            url += '?' + params.toString();
        }
        
        fetch(url)
            .then(response => response.json())
            .then(data => {
                if (data.status === 'success') {
                    showSuccess(data);
                } else {
                    showErrorMessage(data.message || 'Verification failed');
                }
            })
            .catch(error => {
                console.error('Verification error:', error);
                showErrorMessage('An error occurred while verifying tickets. Please try again.');
            })
            .finally(() => {
                // Reset button state
                verifyBtn.disabled = false;
                verifyBtnSpinner.classList.add('d-none');
                verifyBtnText.textContent = 'Verify Tickets';
            });
    }
    
    function showSuccess(data) {
        // Build message based on total number of bookings found
        let message = `<i class="bi bi-check-circle-fill text-success me-2"></i>`;
        if (data.total_bookings > 0) {
            message += `You have ${data.total_bookings} ticket${data.total_bookings > 1 ? 's' : ''} associated with this phone number.`;
        } else {
            message += `No tickets found for this phone number.`;
        }

        resultMessage.innerHTML = message;
        resultContainer.style.display = 'block';
        errorContainer.style.display = 'none';

        // Build ticket details grouped by event
        const bookingDetails = document.getElementById('booking-details');
        let ticketsInfoHTML = `
            <div class="card border-success">
                <div class="card-body">
                    <h5 class="card-title">Your Tickets</h5>
        `;

        // Loop through each event group
        for (const [eventName, bookingList] of Object.entries(data.booking_groups)) {
            ticketsInfoHTML += `
            <div class="mb-4">
                <h6 class="border-bottom pb-2">${eventName}</h6>
                <div class="row">
            `;

            bookingList.forEach(booking => {
                // Determine status badge color and text
                let statusClass = 'bg-secondary';
                let statusText = booking.payment_status;
                if (booking.payment_status === 'PAID') {
                    statusClass = 'bg-success';
                } else if (booking.payment_status === 'PENDING') {
                    statusClass = 'bg-warning text-dark';
                } else if (booking.payment_status === 'FAILED') {
                    statusClass = 'bg-danger';
                }

                ticketsInfoHTML += `
                <div class="col-md-6 mb-3">
                    <div class="card h-100">
                        <div class="card-body">
                            <div class="d-flex justify-content-between align-items-start">
                                <h6 class="card-title">Ticket${booking.ticket_count > 1 ? 's' : ''}</h6>
                                <span class="badge ${statusClass}">${booking.payment_status}</span>
                            </div>
                            <p class="card-text">
                                <strong>Ticket${booking.ticket_count > 1 ? 's' : ''}:</strong> ${booking.ticket_codes.join(', ')}<br>
                                <strong>Qty:</strong> ${booking.ticket_count}<br>
                                <strong>Amount:</strong> KES ${booking.total_amount}<br>
                                ${booking.mpesa_receipt_number ? `<strong>Receipt:</strong> ${booking.mpesa_receipt_number}<br>` : ''}
                                <small class="text-muted">Purchased: ${new Date(booking.created_at).toLocaleString()}</small>
                            </p>
                        </div>
                    </div>
                </div>
                `;
            });

            ticketsInfoHTML += `
                </div>
            </div>
            `;
        }

        ticketsInfoHTML += `
                </div>
            </div>
        `;

        bookingDetails.innerHTML = ticketsInfoHTML;
    }
    
    
    function showErrorMessage(message) {
        errorMessage.textContent = message;
        errorContainer.style.display = 'block';
        resultContainer.style.display = 'none';
    }
});
</script>
{% endblock %}