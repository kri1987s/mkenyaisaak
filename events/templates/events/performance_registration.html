{% extends 'base.html' %}
{% load static %}
{% load event_tags %}

{% block title %}Performance Registration: {{ event.title }} - Mkenya Isaak 7 Million{% endblock %}
{% block meta_description %}Register your group or as an individual artist for {{ event.title }} performance. Submit your performance details for the event at {{ event.venue }} on {{ event.date|date:"F j, Y" }}.{% endblock %}
{% block meta_keywords %}{{ event.title }}, performance registration, event registration, {{ event.venue }}, {{ event.date|date:"Y" }}, artist registration, performer, Kenya events{% endblock %}
{% block og_url %}{{ current_url }}{% endblock %}
{% block og_title %}Performance Registration: {{ event.title }} - Mkenya Isaak 7 Million{% endblock %}
{% block og_description %}Register your group or as an individual artist for {{ event.title }} performance. Submit your performance details for the event at {{ event.venue }} on {{ event.date|date:"F j, Y" }}.{% endblock %}
{% block twitter_url %}{{ current_url }}{% endblock %}
{% block twitter_title %}Performance Registration: {{ event.title }} - Mkenya Isaak 7 Million{% endblock %}
{% block twitter_description %}Register your group or as an individual artist for {{ event.title }} performance. Submit your performance details for the event at {{ event.venue }} on {{ event.date|date:"F j, Y" }}.{% endblock %}

{% block content %}
<div class="container mt-5">
    <div class="row justify-content-center">
        <div class="col-md-8 col-lg-7">
            <div class="card shadow-sm">
                <div class="card-body">
                    <h2 class="card-title text-center mb-4">Register for {{ event.title }} Performance</h2>
                    <p class="text-center text-muted">Use this form to register your group or as an individual artist to perform at {{ event.title }}.</p>

                    {% if messages %}
                        {% for message in messages %}
                            <div class="alert alert-{{ message.tags }}" role="alert">
                                {{ message }}
                            </div>
                        {% endfor %}
                    {% endif %}

                    <form method="post" class="mb-5">
                        {% csrf_token %}
                        {{ form.event }} {# Hidden input for event #}

                        <div class="mb-3">
                            <label for="{{ form.name.id_for_label }}" class="form-label">Name of Group or Artist</label>
                            {{ form.name }}
                            {% if form.name.errors %}
                                {% for error in form.name.errors %}
                                    <small class="text-danger">{{ error }}</small>
                                {% endfor %}
                            {% endif %}
                        </div>

                        <div class="mb-3">
                            <label for="{{ form.category.id_for_label }}" class="form-label">Category of Performance</label>
                            {{ form.category }}
                            {% if form.category.errors %}
                                {% for error in form.category.errors %}
                                    <small class="text-danger">{{ error }}</small>
                                {% endfor %}
                            {% endif %}
                        </div>

                        <div class="mb-3">
                            <label for="{{ form.number_of_performers.id_for_label }}" class="form-label">Number of Performers</label>
                            {{ form.number_of_performers }}
                            {% if form.number_of_performers.errors %}
                                {% for error in form.number_of_performers.errors %}
                                    <small class="text-danger">{{ error }}</small>
                                {% endfor %}
                            {% endif %}
                        </div>

                        <div class="mb-3">
                            <label for="{{ form.phone_number.id_for_label }}" class="form-label">Phone Number</label>
                            {{ form.phone_number }}
                            {% if form.phone_number.errors %}
                                {% for error in form.phone_number.errors %}
                                    <small class="text-danger">{{ error }}</small>
                                {% endfor %}
                            {% endif %}
                        </div>

                        <div class="mb-3">
                            <label for="{{ form.notes.id_for_label }}" class="form-label">Notes / Special Requests (Optional)</label>
                            {{ form.notes }}
                            {% if form.notes.errors %}
                                {% for error in form.notes.errors %}
                                    <small class="text-danger">{{ error }}</small>
                                {% endfor %}
                            {% endif %}
                        </div>

                        <div class="d-grid gap-2">
                            <button type="submit" class="btn btn-primary btn-lg">Submit Registration</button>
                        </div>
                    </form>

                    <p class="text-center mt-4">
                        For any inquiries, please contact us at: <a href="mailto:nafeelkenya@gmail.com">nafeelkenya@gmail.com</a>
                    </p>

                </div>
            </div>
        </div>
    </div>

    {% if user.is_authenticated and user.is_staff %}
    <div class="row justify-content-center mt-5">
        <div class="col-md-10 col-lg-9">
            <div class="card shadow-sm">
                <div class="card-body">
                    <h3 class="card-title text-center mb-4">Registered Performances for {{ event.title }}</h3>
                    {% if performances %}
                        <div class="d-flex justify-content-end mb-3">
                            <button class="btn btn-outline-secondary btn-sm" onclick="printTable()">
                                <i class="fas fa-print me-1"></i> Print Table
                            </button>
                        </div>
                        <div class="table-responsive">
                            <table class="table table-striped table-hover" id="performancesTable">
                                <thead>
                                    <tr>
                                        <th scope="col">Artist/Group Name</th>
                                        <th scope="col">Category</th>
                                        <th scope="col">Performers</th>
                                        <th scope="col">Phone</th>
                                        <th scope="col">Notes</th>
                                        <th scope="col">Registered On</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    {% for performance in performances %}
                                        <tr>
                                            <td>{{ performance.name }}</td>
                                            <td>{{ performance.get_category_display }}</td>
                                            <td>{{ performance.number_of_performers }}</td>
                                            <td>{{ performance.phone_number }}</td>
                                            <td>{{ performance.notes|default:"-" }}</td>
                                            <td>{{ performance.created_at|date:"Y-m-d H:i" }}</td>
                                        </tr>
                                    {% endfor %}
                                </tbody>
                            </table>
                        </div>
                    {% else %}
                        <p class="text-center text-muted">No performances registered yet for this event.</p>
                    {% endif %}
                </div>
            </div>
        </div>
    </div>

    <div class="row justify-content-center mt-5">
        <div class="col-md-10 col-lg-9">
            <div class="card shadow-sm">
                <div class="card-body">
                    <h3 class="card-title text-center mb-4">Unique Phone Numbers for WhatsApp</h3>
                    {% if unique_phone_numbers %}
                        <div class="table-responsive">
                            <table class="table table-striped table-hover">
                                <thead>
                                    <tr>
                                        <th scope="col">#</th>
                                        <th scope="col">Phone Number</th>
                                        <th scope="col">WhatsApp Link</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    {% for phone_number in unique_phone_numbers %}
                                        <tr>
                                            <td>{{ forloop.counter }}</td>
                                            <td>{{ phone_number }}</td>
                                            <td>
                                                <a href="https://wa.me/{{ phone_number|format_phone_for_whatsapp }}" target="_blank" class="btn btn-success btn-sm">
                                                    <i class="fab fa-whatsapp"></i> Send Message
                                                </a>
                                            </td>
                                        </tr>
                                    {% endfor %}
                                </tbody>
                            </table>
                        </div>
                    {% else %}
                        <p class="text-center text-muted">No unique phone numbers found.</p>
                    {% endif %}
                </div>
            </div>
        </div>
    </div>
    {% endif %}

</div>
{% endblock %}

{% block extra_js %}
<script>
    function printTable() {
        const printContent = document.getElementById('performancesTable').outerHTML;
        const WindowObject = window.open('', 'PrintWindow', 'width=750,height=650,top=50,left=50,toolbars=no,scrollbars=yes,status=no,resizable=yes');
        WindowObject.document.writeln('<!DOCTYPE html>');
        WindowObject.document.writeln('<html><head><title>Print Performance Table</title>');
        // Include Bootstrap CSS for styling in print preview
        WindowObject.document.writeln('<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">');
        WindowObject.document.writeln('</head><body>');
        WindowObject.document.writeln('<h3>Registered Performances</h3>');
        WindowObject.document.writeln(printContent);
        WindowObject.document.writeln('</body></html>');
        WindowObject.document.close();
        WindowObject.focus();
        WindowObject.print();
        WindowObject.close();
    }
</script>
{% endblock %}
